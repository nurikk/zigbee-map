!function(){"use strict";var t;!function(t){!function(t){t.EndDevice="EndDevice",t.Router="Router",t.Coordinator="Coordinator"}(t.DeviceType||(t.DeviceType={}))}(t||(t={}));var e,n,r,a={ieeeAddr:"",last_seen:(Date.now()/1e3).toString(),type:t.DeviceType.Coordinator,ManufName:"sls",ModelId:"sls",st:{linkquality:1},friendly_name:"sls gateway"},i=((e={})[t.DeviceType.Coordinator]="blue",e[t.DeviceType.Router]="green",e[t.DeviceType.EndDevice]="red",e),o=function(e){var o=d3.select(e);o.selectAll("*").remove();var c,d,s,l,u=o.node().getBoundingClientRect(),f=u.width,p=u.height,y=o.append("svg");y.attr("viewBox","0 0 "+f+" "+p).attr("preserveAspectRatio","xMidYMid meet");var v=d3.forceSimulation().force("x",d3.forceX(f/2).strength(.05)).force("y",d3.forceY(p/2).strength(.05)).force("link",d3.forceLink().id((function(t){return t.id})).distance(50).strength(.1)).force("charge",d3.forceManyBody().distanceMin(10).strength(-200)).force("center",d3.forceCenter(f/2,p/2)).on("tick",(function(){d.attr("x1",(function(t){return t.source.x})).attr("y1",(function(t){return t.source.y})).attr("x2",(function(t){return t.target.x})).attr("y2",(function(t){return t.target.y})),c.attr("transform",(function(t){return"translate("+t.x+", "+t.y+")"})),s.attr("d",(function(t){return"M "+t.source.x+" "+t.source.y+" L "+t.target.x+" "+t.target.y})),l.attr("transform",(function(t){if(t.target.x<t.source.x){var e=this.getBBox();return"rotate(180 "+(e.x+e.width/2)+" "+(e.y+e.height/2)+")"}return"rotate(0)"}))})).stop();d3.json("/api/time").then((function(t){r=t})).finally((function(){d3.json("/api/zigbee/devices").then((function(e){n=function(t){var e={id:"SLS GW",device:a},n={nodes:[e],links:[]};return Object.entries(t).forEach((function(t){var r=t[0],a=t[1];n.nodes.push({id:r,device:a}),Array.isArray(a.Rtg)&&a.Rtg.length?a.Rtg.forEach((function(t){n.links.push({source:r,target:t.toString(),linkQuality:a.st.linkquality})})):n.links.push({source:r,target:e.id,linkQuality:a.st.linkquality})})),n}(e),function(){var e=n.links,a=n.nodes;d=y.selectAll(".link").data(e).enter().append("line").attr("class","link").style("stroke","#999").style("stroke-opacity","0.6").style("stroke-width","1px"),c=y.selectAll(".node").data(a).enter().append("g").attr("class","node").style("cursor","pointer").attr("fill-opacity",(function(t){return e=t.device,!r||!r.ts||r.ts-parseInt(e.last_seen,10)<7200?1:.4;var e})).call(function(t){return d3.drag().on("start",(function(e){d3.event.active||t.alphaTarget(.3).restart(),e.fx=e.x,e.fy=e.y})).on("drag",(function(t){t.fx=d3.event.x,t.fy=d3.event.y})).on("end",(function(e){d3.event.active||t.alphaTarget(0),e.fx=void 0,e.fy=void 0}))}(v));var o=d3.radialLine(),u=[[0,14],[.2*Math.PI,5],[.4*Math.PI,14],[.6*Math.PI,5],[.8*Math.PI,14],[1*Math.PI,5],[1.2*Math.PI,14],[1.4*Math.PI,5],[1.6*Math.PI,14],[1.8*Math.PI,5],[2*Math.PI,14]],f=d3.path();f.arc(0,0,5,0,2*Math.PI);var p=o(u);c.append("path").attr("fill",(function(t){return e=t.device,i[e.type];var e})).attr("d",(function(e){switch(e.device.type){case t.DeviceType.Coordinator:return p;default:return f}})),c.append("title").text((function(t){return(e=t.device).ieeeAddr+"\n"+e.ManufName+" "+e.ModelId;var e})),c.append("text").attr("dy",-5).text((function(t){return e=t.device,n=e.friendly_name,r=e.ieeeAddr,n||""+r.slice(-4);var e,n,r})),s=y.selectAll(".edgepath").data(e).enter().append("path").attr("class","edgepath").attr("fill-opacity",0).attr("stroke-opacity",0).attr("id",(function(t,e){return"edgepath"+e})).style("pointer-events","none"),(l=y.selectAll(".edgelabel").data(e).enter().append("text").style("pointer-events","none").attr("class","edgelabel").attr("id",(function(t,e){return"edgelabel"+e})).attr("font-size",10).attr("fill","#aaa").attr("dy","10")).append("textPath").attr("xlink:href",(function(t,e){return"#edgepath"+e})).style("text-anchor","middle").style("pointer-events","none").attr("startOffset","50%").text((function(t){return t.linkQuality})),v.nodes(a),v.force("link").links(e),v.restart()}()}))}))};document.addEventListener("DOMContentLoaded",(function(){return o("#map")}),!1)}();
